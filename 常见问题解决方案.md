# K线图常见问题解决方案

## 问题1: Failed to resolve component: KLineChart

### 错误信息
```
[Vue warn]: Failed to resolve component: KLineChart
```

### 原因
Nuxt3 的 SSR（服务端渲染）无法处理需要浏览器环境的组件（如使用 canvas 的 KLineChart）。

### 解决方案
使用 `defineAsyncComponent` 动态导入组件，配合 `ClientOnly` 组件：

```vue
<script setup>
import { defineAsyncComponent } from 'vue'

const KLineChart = defineAsyncComponent(() => 
  import('../components/KLineChart.vue')
)
</script>

<template>
  <ClientOnly>
    <KLineChart />
    <template #fallback>
      <div>正在加载...</div>
    </template>
  </ClientOnly>
</template>
```

**记得重启开发服务器！**

---

## 问题2: chart.setSymbol is not a function

### 错误信息
```
TypeError: chart.setSymbol is not a function
```

### 原因
1. **版本过低**：`setSymbol` 和 `setPeriod` 是在 `klinecharts@10.0.0-alpha7` 才新增的 API
2. `init()` 函数可能返回 `null`（DOM 元素未就绪）
3. API 调用顺序不正确

### 解决方案 - 版本检查（最重要！）

#### 检查当前版本
```bash
npm list klinecharts
```

如果版本低于 `10.0.0-alpha7`，需要升级：

```bash
# 升级到最新版本
npm install klinecharts@10.0.0-alpha9 --save

# 或者升级到最新的稳定版
npm install klinecharts@latest --save
```

**升级后必须重启开发服务器！**

### 解决方案

#### 1. 确保 DOM 已就绪
```javascript
import { nextTick } from 'vue'

onMounted(async () => {
  // 等待 DOM 完全渲染
  await nextTick()
  
  // 初始化图表
  chart = init('kline-chart')
  
  // 检查 chart 是否成功初始化
  if (!chart) {
    console.error('图表初始化失败')
    return
  }
  
  // ... 后续代码
})
```

#### 2. 正确的 API 调用顺序

⚠️ **重要**：必须先设置 `symbol` 和 `period`，然后才能使用 `setDataLoader`

```javascript
// ✅ 正确顺序
chart.setSymbol({ ticker: 'ETH-USDT' })    // 1. 先设置交易对
chart.setPeriod({ span: 1, type: 'day' })  // 2. 再设置周期
chart.setDataLoader({                       // 3. 最后设置数据加载器
  getBars: ({ callback }) => {
    callback(data)
  }
})
```

```javascript
// ❌ 错误顺序 - 会导致数据无法加载
chart.setDataLoader({ ... })  // setDataLoader 需要 symbol 和 period
chart.setSymbol({ ... })
chart.setPeriod({ ... })
```

#### 3. 完整示例

```javascript
onMounted(async () => {
  await nextTick()
  
  const chart = init('kline-chart')
  
  if (!chart) {
    console.error('图表初始化失败')
    return
  }
  
  // 1. 设置交易对
  chart.setSymbol({ 
    ticker: 'ETH-USDT',
    exchange: 'OKX'
  })
  
  // 2. 设置周期
  chart.setPeriod({ 
    span: 1,
    type: 'day'
  })
  
  // 3. 加载数据
  chart.setDataLoader({
    getBars: ({ callback }) => {
      const data = transformData(rawData)
      callback(data)
    }
  })
  
  // 4. 创建指标
  chart.createIndicator('VOL', false, { id: 'candle_pane' })
})
```

---

## 问题3: 数据无法显示

### 可能原因
1. 数据格式不正确
2. 时间戳格式错误
3. 数据为空

### 解决方案

#### 1. 检查数据格式
确保数据格式符合 KLineChart 要求：

```javascript
{
  timestamp: 1759939200000,  // 毫秒级时间戳（13位）
  open: 4445.04,            // 开盘价
  high: 4555.9,             // 最高价
  low: 4288.0,              // 最低价
  close: 4312.36,           // 收盘价
  volume: 3600506.03        // 成交量
}
```

#### 2. 时间戳转换
如果时间戳是字符串，需要转换为数字：

```javascript
const transformData = (data) => {
  return data.map(item => ({
    timestamp: parseInt(item.时间戳),  // 确保是数字
    open: item.开盘价,
    high: item.最高价,
    low: item.最低价,
    close: item.收盘价,
    volume: item['成交量(币)']
  }))
}
```

#### 3. 调试数据
```javascript
const transformedData = transformData(rawData)
console.log('数据长度:', transformedData.length)
console.log('第一条数据:', transformedData[0])
console.log('最后一条数据:', transformedData[transformedData.length - 1])
```

---

## 问题4: 需要重启开发服务器

### 什么时候需要重启？

以下情况**必须**重启开发服务器：
- ✅ 修改了组件导入方式
- ✅ 修改了 nuxt.config.ts
- ✅ 添加或删除了组件文件
- ✅ 修改了文件名（如 .vue 改为 .client.vue）

### 如何重启

```bash
# 1. 停止服务器
按 Ctrl + C

# 2. 清除缓存（可选，但推荐）
rm -rf .nuxt
# 或 Windows PowerShell
Remove-Item -Recurse -Force .nuxt

# 3. 重新启动
npm run dev
```

---

## 问题5: 图表显示空白

### 检查清单

1. **检查 DOM 元素 ID 是否匹配**
   ```vue
   <div id="kline-chart"></div>
   ```
   ```javascript
   chart = init('kline-chart')  // ID 必须一致
   ```

2. **检查容器高度**
   ```css
   .chart {
     width: 100%;
     height: 700px;  /* 必须有明确的高度 */
   }
   ```

3. **检查数据是否为空**
   ```javascript
   if (transformedData.length === 0) {
     console.error('没有数据')
     return
   }
   ```

4. **打开浏览器控制台检查错误**
   按 F12 打开控制台查看是否有错误信息

---

## 问题6: 图表性能问题

### 优化建议

1. **限制数据量**
   ```javascript
   // 只加载最近的数据
   const recentData = rawData.slice(-200)
   const transformedData = transformData(recentData)
   ```

2. **延迟加载指标**
   ```javascript
   // 先加载图表，稍后再添加指标
   setTimeout(() => {
     chart.createIndicator('VOL')
   }, 100)
   ```

3. **使用虚拟滚动**
   KLineChart 内置了虚拟滚动，只渲染可见区域

---

## 调试技巧

### 1. 检查 KLineChart 版本
```javascript
import { version } from 'klinecharts'
console.log('KLineChart 版本:', version())
```

### 2. 监听图表事件
```javascript
chart.subscribeAction('onCrosshairChange', (data) => {
  console.log('十字线变化:', data)
})
```

### 3. 获取图表数据
```javascript
const dataList = chart.getDataList()
console.log('当前图表数据:', dataList)
```

---

## 获取帮助

如果以上方法都无法解决问题：

1. 查看 [KLineChart 官方文档](https://www.klinecharts.com)
2. 查看 [GitHub Issues](https://github.com/klinecharts/KLineChart/issues)
3. 加入 [Telegram 群组](https://t.me/klinecharts)
4. 检查浏览器控制台的完整错误信息

